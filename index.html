<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rohan X Uploader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-radius: 50%;
            border-top: 4px solid #3498db;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">
    <div class="bg-gray-800 p-8 rounded-lg shadow-2xl w-full max-w-md">
        <h1 class="text-3xl font-bold text-center mb-2 text-cyan-400">Rohan X Uploader</h1>
        <p class="text-center text-gray-400 mb-6">Copy any Google Drive file to your drive in a flash.</p>

        <div id="auth-container">
            <div id="initial-loader" class="loader"></div>
            <p id="initial-message" class="text-center text-gray-400">Initializing Google Services...</p>
            <button id="authorize_button" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105" style="display: none;">
                Authorize with Google
            </button>
        </div>

        <div id="uploader-container" class="hidden">
            <div class="mb-4">
                <label for="fileUrl" class="block text-gray-400 text-sm font-bold mb-2">Source File URL:</label>
                <input type="text" id="fileUrl" class="shadow-inner appearance-none border border-gray-700 rounded-lg w-full py-3 px-4 bg-gray-700 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Enter Google Drive file URL">
            </div>
            <div class="mb-6">
                <label for="folderId" class="block text-gray-400 text-sm font-bold mb-2">Destination Folder ID (Optional):</label>
                <input type="text" id="folderId" class="shadow-inner appearance-none border border-gray-700 rounded-lg w-full py-3 px-4 bg-gray-700 text-gray-200 leading-tight focus:outline-none focus:ring-2 focus:ring-cyan-500" placeholder="Enter destination folder ID">
                 <p class="text-xs text-gray-500 mt-1">If left blank, the file will be copied to your 'My Drive' root.</p>
            </div>
            <button id="copy_button" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                Copy File
            </button>
            <button id="signout_button" class="w-full mt-3 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                Sign Out
            </button>
        </div>

        <div id="message" class="mt-6 text-center"></div>
    </div>
    
    <script>
        // --- Configuration ---
        const CLIENT_ID = "917652135636-fig5jstj49aj8rmbdjj0als4126ehmcm.apps.googleusercontent.com";
        const API_KEY = "AIzaSyBB-dcmDtOcuMlmQ4BGje2BjrdagI1EG6s";
        const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file';

        // --- DOM Elements ---
        const authorizeButton = document.getElementById('authorize_button');
        const signoutButton = document.getElementById('signout_button');
        const copyButton = document.getElementById('copy_button');
        const messageDiv = document.getElementById('message');
        const authContainer = document.getElementById('auth-container');
        const uploaderContainer = document.getElementById('uploader-container');
        const initialLoader = document.getElementById('initial-loader');
        const initialMessage = document.getElementById('initial-message');

        // --- Global State ---
        let gapiInited = false;
        let gisInited = false;
        let tokenClient;

        // --- Initialization ---
        function gapiLoaded() {
            gapi.load('client', initializeGapiClient);
        }

        async function initializeGapiClient() {
            try {
                await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
                gapiInited = true;
                checkReadyState();
            } catch (error) {
                handleError('GAPI client initialize karne mein error. API Key check karein.', error);
            }
        }

        function gisLoaded() {
            try {
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: SCOPES,
                    callback: handleAuthResponse, // Yeh function safal auth response ko handle karega
                });
                gisInited = true;
                checkReadyState();
            } catch (error) {
                handleError('Google Identity Services initialize karne mein error. Client ID check karein.', error);
            }
        }

        function checkReadyState() {
            if (gapiInited && gisInited) {
                initialLoader.style.display = 'none';
                initialMessage.style.display = 'none';
                authorizeButton.style.display = 'block';
                showMessage('Authorize karne ke liye taiyar.', 'gray');
            }
        }

        // --- Auth Flow ---
        authorizeButton.onclick = function() {
            if (tokenClient) {
                tokenClient.requestAccessToken();
            } else {
                handleError('Authorization client taiyar nahi hai.');
            }
        };

        function handleAuthResponse(response) {
            if (response.error) {
                handleError(`Authorization fail ho gayi: ${response.error}`, response);
                return;
            }
            // Token ko GAPI client ko pass karein
            gapi.client.setToken(response);
            // Uploader UI dikhayein
            authContainer.style.display = 'none';
            uploaderContainer.style.display = 'block';
            showMessage('Authorization safal!', 'green');
        }

        signoutButton.onclick = function() {
            const token = gapi.client.getToken();
            if (token) {
                google.accounts.oauth2.revoke(token.access_token, () => {
                    gapi.client.setToken(null);
                    uploaderContainer.style.display = 'none';
                    authContainer.style.display = 'block';
                    showMessage('Aap sign out ho chuke hain.', 'gray');
                });
            }
        };

        // --- Core Logic ---
        copyButton.onclick = async function() {
            const fileUrl = document.getElementById('fileUrl').value;
            if (!fileUrl) {
                showMessage('Kripya source file URL dalein.', 'red');
                return;
            }
            const fileId = getFileIdFromUrl(fileUrl);
            if (!fileId) {
                showMessage('Anya Google Drive URL. Link check karein.', 'red');
                return;
            }

            showMessage('', 'gray'); // Pichhla message saaf karein
            const copyLoader = document.createElement('div');
            copyLoader.className = 'loader';
            messageDiv.appendChild(copyLoader);
            messageDiv.insertAdjacentText('beforeend', 'File copy ho rahi hai...');


            try {
                const meta = await gapi.client.drive.files.get({ fileId: fileId, fields: 'name' });
                const response = await gapi.client.drive.files.copy({
                    fileId: fileId,
                    resource: { name: `Copy of ${meta.result.name}` },
                    fields: 'id, webViewLink'
                });
                showMessage(`File safaltapoorvak copy ho gayi!`, 'green', response.result.webViewLink);
            } catch (error) {
                handleError('File copy karne mein fail. Permissions ya link check karein.', error);
            }
        };

        // --- Utility Functions ---
        function getFileIdFromUrl(url) {
            const regexes = [
                /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/,
                /drive\.google\.com\/open\?id=([a-zA-Z0-9_-]+)/,
                /drive\.google\.com\/uc\?id=([a-zA-Z0-9_-]+)/,
            ];
            for (const regex of regexes) {
                const match = url.match(regex);
                if (match && match[1]) return match[1];
            }
            return null;
        }

        function showMessage(text, color, linkUrl = null) {
            messageDiv.innerHTML = ''; // Pichhla content saaf karein
            messageDiv.textContent = text;
            const colorClasses = {
                red: 'text-red-400',
                green: 'text-green-400',
                yellow: 'text-yellow-400',
                gray: 'text-gray-400'
            };
            messageDiv.className = `mt-6 text-center ${colorClasses[color] || 'text-gray-400'}`;
            if (linkUrl) {
                const link = document.createElement('a');
                link.href = linkUrl;
                link.textContent = 'Copy ki gayi file dekhein';
                link.target = '_blank';
                link.className = 'text-cyan-400 hover:underline ml-2';
                messageDiv.appendChild(link);
            }
        }

        function handleError(userMessage, errorObject) {
            console.error(userMessage, errorObject || '');
            showMessage(userMessage, 'red');
            initialLoader.style.display = 'none';
            initialMessage.style.display = 'none';
            authorizeButton.style.display = 'block'; // Error ke baad bhi button dikhayein
            authorizeButton.textContent = 'Try Again';
        }
    </script>
    
    <!-- Dono scripts ko yahan load kiya ja raha hai -->
    <script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>
</body>
</html>
